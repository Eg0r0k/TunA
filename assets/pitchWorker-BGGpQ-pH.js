var Nt=Object.defineProperty;var Vt=(R,w,M)=>w in R?Nt(R,w,{enumerable:!0,configurable:!0,writable:!0,value:M}):R[w]=M;var y=(R,w,M)=>Vt(R,typeof w!="symbol"?w+"":w,M);(function(){"use strict";function R(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var w,M;function mt(){if(M)return w;M=1;function o(s){if(this.size=s|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=s<<1;for(var t=new Array(this.size*2),r=0;r<t.length;r+=2){const u=Math.PI*r/this.size;t[r]=Math.cos(u),t[r+1]=-Math.sin(u)}this.table=t;for(var e=0,n=1;this.size>n;n<<=1)e++;this._width=e%2===0?e-1:e,this._bitrev=new Array(1<<this._width);for(var a=0;a<this._bitrev.length;a++){this._bitrev[a]=0;for(var i=0;i<this._width;i+=2){var c=this._width-i-2;this._bitrev[a]|=(a>>>i&3)<<c}}this._out=null,this._data=null,this._inv=0}return w=o,o.prototype.fromComplexArray=function(t,r){for(var e=r||new Array(t.length>>>1),n=0;n<t.length;n+=2)e[n>>>1]=t[n];return e},o.prototype.createComplexArray=function(){const t=new Array(this._csize);for(var r=0;r<t.length;r++)t[r]=0;return t},o.prototype.toComplexArray=function(t,r){for(var e=r||this.createComplexArray(),n=0;n<e.length;n+=2)e[n]=t[n>>>1],e[n+1]=0;return e},o.prototype.completeSpectrum=function(t){for(var r=this._csize,e=r>>>1,n=2;n<e;n+=2)t[r-n]=t[n],t[r-n+1]=-t[n+1]},o.prototype.transform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=0,this._transform4(),this._out=null,this._data=null},o.prototype.realTransform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=0,this._realTransform4(),this._out=null,this._data=null},o.prototype.inverseTransform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=1,this._transform4();for(var e=0;e<t.length;e++)t[e]/=this.size;this._out=null,this._data=null},o.prototype._transform4=function(){var t=this._out,r=this._csize,e=this._width,n=1<<e,a=r/n<<1,i,c,u=this._bitrev;if(a===4)for(i=0,c=0;i<r;i+=a,c++){const l=u[c];this._singleTransform2(i,l,n)}else for(i=0,c=0;i<r;i+=a,c++){const l=u[c];this._singleTransform4(i,l,n)}var f=this._inv?-1:1,h=this.table;for(n>>=2;n>=2;n>>=2){a=r/n<<1;var v=a>>>2;for(i=0;i<r;i+=a)for(var p=i+v,b=i,_=0;b<p;b+=2,_+=n){const l=b,m=l+v,d=m+v,g=d+v,A=t[l],I=t[l+1],T=t[m],F=t[m+1],B=t[d],x=t[d+1],E=t[g],C=t[g+1],z=A,N=I,V=h[_],D=f*h[_+1],S=T*V-F*D,Y=T*D+F*V,K=h[2*_],H=f*h[2*_+1],J=B*K-x*H,W=B*H+x*K,Z=h[3*_],j=f*h[3*_+1],L=E*Z-C*j,q=E*j+C*Z,k=z+J,U=N+W,P=z-J,O=N-W,tt=S+L,Q=Y+q,$=f*(S-L),rt=f*(Y-q),nt=k+tt,ot=U+Q,it=k-tt,at=U-Q,ct=P+rt,ft=O-$,ht=P-rt,lt=O+$;t[l]=nt,t[l+1]=ot,t[m]=ct,t[m+1]=ft,t[d]=it,t[d+1]=at,t[g]=ht,t[g+1]=lt}}},o.prototype._singleTransform2=function(t,r,e){const n=this._out,a=this._data,i=a[r],c=a[r+1],u=a[r+e],f=a[r+e+1],h=i+u,v=c+f,p=i-u,b=c-f;n[t]=h,n[t+1]=v,n[t+2]=p,n[t+3]=b},o.prototype._singleTransform4=function(t,r,e){const n=this._out,a=this._data,i=this._inv?-1:1,c=e*2,u=e*3,f=a[r],h=a[r+1],v=a[r+e],p=a[r+e+1],b=a[r+c],_=a[r+c+1],l=a[r+u],m=a[r+u+1],d=f+b,g=h+_,A=f-b,I=h-_,T=v+l,F=p+m,B=i*(v-l),x=i*(p-m),E=d+T,C=g+F,z=A+x,N=I-B,V=d-T,D=g-F,S=A-x,Y=I+B;n[t]=E,n[t+1]=C,n[t+2]=z,n[t+3]=N,n[t+4]=V,n[t+5]=D,n[t+6]=S,n[t+7]=Y},o.prototype._realTransform4=function(){var t=this._out,r=this._csize,e=this._width,n=1<<e,a=r/n<<1,i,c,u=this._bitrev;if(a===4)for(i=0,c=0;i<r;i+=a,c++){const ut=u[c];this._singleRealTransform2(i,ut>>>1,n>>>1)}else for(i=0,c=0;i<r;i+=a,c++){const ut=u[c];this._singleRealTransform4(i,ut>>>1,n>>>1)}var f=this._inv?-1:1,h=this.table;for(n>>=2;n>=2;n>>=2){a=r/n<<1;var v=a>>>1,p=v>>>1,b=p>>>1;for(i=0;i<r;i+=a)for(var _=0,l=0;_<=b;_+=2,l+=n){var m=i+_,d=m+p,g=d+p,A=g+p,I=t[m],T=t[m+1],F=t[d],B=t[d+1],x=t[g],E=t[g+1],C=t[A],z=t[A+1],N=I,V=T,D=h[l],S=f*h[l+1],Y=F*D-B*S,K=F*S+B*D,H=h[2*l],J=f*h[2*l+1],W=x*H-E*J,Z=x*J+E*H,j=h[3*l],L=f*h[3*l+1],q=C*j-z*L,k=C*L+z*j,U=N+W,P=V+Z,O=N-W,tt=V-Z,Q=Y+q,$=K+k,rt=f*(Y-q),nt=f*(K-k),ot=U+Q,it=P+$,at=O+nt,ct=tt-rt;if(t[m]=ot,t[m+1]=it,t[d]=at,t[d+1]=ct,_===0){var ft=U-Q,ht=P-$;t[g]=ft,t[g+1]=ht;continue}if(_!==b){var lt=O,Ft=-tt,At=U,Tt=-P,It=-f*nt,Bt=-f*rt,xt=-f*$,Rt=-f*Q,Mt=lt+It,Et=Ft+Bt,Ct=At+Rt,zt=Tt-xt,_t=i+p-_,vt=i+v-_;t[_t]=Mt,t[_t+1]=Et,t[vt]=Ct,t[vt+1]=zt}}}},o.prototype._singleRealTransform2=function(t,r,e){const n=this._out,a=this._data,i=a[r],c=a[r+e],u=i+c,f=i-c;n[t]=u,n[t+1]=0,n[t+2]=f,n[t+3]=0},o.prototype._singleRealTransform4=function(t,r,e){const n=this._out,a=this._data,i=this._inv?-1:1,c=e*2,u=e*3,f=a[r],h=a[r+e],v=a[r+c],p=a[r+u],b=f+v,_=f-v,l=h+p,m=i*(h-p),d=b+l,g=_,A=-m,I=b-l,T=_,F=m;n[t]=d,n[t+1]=0,n[t+2]=g,n[t+3]=A,n[t+4]=I,n[t+5]=0,n[t+6]=T,n[t+7]=F},w}var dt=mt(),pt=R(dt);class X{constructor(s,t){y(this,"_inputLength");y(this,"_fft");y(this,"_bufferSupplier");y(this,"_paddedInputBuffer");y(this,"_transformBuffer");y(this,"_inverseBuffer");if(s<1)throw new Error("Input length must be at least one");this._inputLength=s,this._fft=new pt(yt(2*s)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(s){return new X(s,t=>new Float32Array(t))}static forFloat64Array(s){return new X(s,t=>new Float64Array(t))}static forNumberArray(s){return new X(s,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(s,t=this._bufferSupplier(s.length)){if(s.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${s.length}`);for(let e=0;e<s.length;e++)this._paddedInputBuffer[e]=s[e];for(let e=s.length;e<this._paddedInputBuffer.length;e++)this._paddedInputBuffer[e]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const r=this._transformBuffer;for(let e=0;e<r.length;e+=2)r[e]=r[e]*r[e]+r[e+1]*r[e+1],r[e+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let e=0;e<s.length;e++)t[e]=this._inverseBuffer[2*e];return t}}function gt(o){const s=[];let t=!1,r=-1/0,e=-1;for(let n=1;n<o.length-1;n++)o[n-1]<=0&&o[n]>0?(t=!0,e=n,r=o[n]):o[n-1]>0&&o[n]<=0?(t=!1,e!==-1&&s.push(e)):t&&o[n]>r&&(r=o[n],e=n);return s}function bt(o,s){const[t,r,e]=[o-1,o,o+1],[n,a,i]=[s[t],s[r],s[e]],c=n/2-a+i/2,u=-(n/2)*(r+e)+a*(t+e)-i/2*(t+r),f=n*r*e/2-a*t*e+i*t*r/2,h=-u/(2*c),v=c*h*h+u*h+f;return[h,v]}class G{constructor(s,t){y(this,"_autocorrelator");y(this,"_nsdfBuffer");y(this,"_clarityThreshold",.9);y(this,"_minVolumeAbsolute",0);y(this,"_maxInputAmplitude",1);this._autocorrelator=new X(s,t),this._nsdfBuffer=t(s)}static forFloat32Array(s){return new G(s,t=>new Float32Array(t))}static forFloat64Array(s){return new G(s,t=>new Float64Array(t))}static forNumberArray(s){return new G(s,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(s){if(!Number.isFinite(s)||s<=0||s>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=s}set minVolumeAbsolute(s){if(!Number.isFinite(s)||s<0||s>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=s}set minVolumeDecibels(s){if(!Number.isFinite(s)||s>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(s/10)}set maxInputAmplitude(s){if(!Number.isFinite(s)||s<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=s}findPitch(s,t){if(this._belowMinimumVolume(s))return[0,0];this._nsdf(s);const r=gt(this._nsdfBuffer);if(r.length===0)return[0,0];const e=Math.max(...r.map(c=>this._nsdfBuffer[c])),n=r.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*e),[a,i]=bt(n,this._nsdfBuffer);return[t/a,Math.min(i,1)]}_belowMinimumVolume(s){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let r=0;r<s.length;r++)t+=s[r]**2;return Math.sqrt(t/s.length)<this._minVolumeAbsolute}_nsdf(s){this._autocorrelator.autocorrelate(s,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],r;for(r=0;r<this._nsdfBuffer.length&&t>0;r++)this._nsdfBuffer[r]=2*this._nsdfBuffer[r]/t,t-=s[r]**2+s[s.length-r-1]**2;for(;r<this._nsdfBuffer.length;r++)this._nsdfBuffer[r]=0}}function yt(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o}const et={MIN_FREQUENCY:20,MAX_FREQUENCY:2e4,MIN_CLARITY:.8};let st=null;const wt=(o,s)=>s>et.MIN_CLARITY&&o>=et.MIN_FREQUENCY&&o<=et.MAX_FREQUENCY;self.onmessage=o=>{const{buffer:s,sampleRate:t}=o.data;st||(st=G.forFloat32Array(s.length));const[r,e]=st.findPitch(s,t);wt(r,e)&&self.postMessage({pitch:r,clarity:e})},self.onclose=()=>{st=null}})();
